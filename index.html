<script>
  // animación scroll
  const elements = document.querySelectorAll('[data-animate]');
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
        observer.unobserve(entry.target);
      }
    });
  }, {threshold: 0.2});
  elements.forEach(el => observer.observe(el));

  // referencias del producto principal
  const similarCards = document.querySelectorAll('.similar-card');
  const nameEl = document.getElementById('product-name');
  const descEl = document.getElementById('product-desc');
  const priceEl = document.getElementById('product-price');
  const badgeEl = document.getElementById('product-badge');
  const imgEl = document.getElementById('product-image');

  // carrito
  const cartBtn = document.getElementById('cart-btn');
  const cartPanel = document.getElementById('cart-panel');
  const cartCount = document.getElementById('cart-count');
  const cartItemsContainer = document.getElementById('cart-items');
  const mainAddBtn = document.getElementById('product-cart');

  let cart = {}; // estructura del carrito

  function updateCartPanel() {
    const keys = Object.keys(cart);
    if (keys.length === 0) {
      cartItemsContainer.innerHTML = '<p class="cart-empty">No hay productos aún.</p>';
      return;
    }
    cartItemsContainer.innerHTML = '';
    keys.forEach(k => {
      const item = cart[k];
      const row = document.createElement('div');
      row.className = 'cart-item';
      row.innerHTML = `
        <span>${k} x ${item.qty}</span>
        <div style="display:flex;align-items:center;gap:6px;">
          <strong>${item.price}</strong>
          <button style="border:none;background:none;color:#d72638;font-size:1rem;cursor:pointer;" title="Eliminar" onclick="removeFromCart('${k}')">&times;</button>
        </div>
      `;
      cartItemsContainer.appendChild(row);
    });
  }

  function addToCart(name, price) {
    if (!cart[name]) {
      cart[name] = { qty: 1, price };
    } else {
      cart[name].qty += 1;
    }

    // actualizar contador
    const totalItems = Object.values(cart).reduce((acc, item) => acc + item.qty, 0);
    cartCount.textContent = totalItems;
    updateCartPanel();

    // animación de carrito
    cartBtn.classList.add('cart-bounce');
    setTimeout(() => cartBtn.classList.remove('cart-bounce'), 400);
    if (navigator.vibrate) navigator.vibrate(80);
  }

  function removeFromCart(name) {
    if (cart[name]) {
      cart[name].qty -= 1;
      if (cart[name].qty <= 0) delete cart[name];
      const totalItems = Object.values(cart).reduce((acc, item) => acc + item.qty, 0);
      cartCount.textContent = totalItems;
      updateCartPanel();
    }
  }

  // cambiar producto principal al hacer click en tarjetas
  similarCards.forEach(card => {
    card.addEventListener('click', e => {
      if (e.target.closest('.buy-btn')) return;

      similarCards.forEach(c => c.classList.remove('active'));
      card.classList.add('active');

      nameEl.textContent = card.dataset.name;
      priceEl.textContent = card.dataset.price;
      descEl.textContent = card.dataset.desc;
      badgeEl.textContent = card.dataset.badge;
      imgEl.src = card.dataset.img;
    });

    const btnInside = card.querySelector('.buy-btn');
    btnInside.addEventListener('click', e => {
      e.stopPropagation();
      addToCart(card.dataset.name, card.dataset.price);
    });
  });

  mainAddBtn.addEventListener('click', () => {
    addToCart(nameEl.textContent, priceEl.textContent);
  });

  // mostrar / ocultar carrito
  cartBtn.addEventListener('click', e => {
    e.stopPropagation();
    cartPanel.style.display = cartPanel.style.display === 'block' ? 'none' : 'block';
  });

  // cerrar carrito si se hace click fuera
  document.addEventListener('click', e => {
    if (!cartPanel.contains(e.target) && !cartBtn.contains(e.target)) {
      cartPanel.style.display = 'none';
    }
  });
</script>
